@page
@model WebApplication1.Pages.Account.ChangePasswordModel
@{
    ViewData["Title"] = "Change Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header @(Model.IsPasswordExpired ? "bg-danger text-white" : "bg-primary text-white")">
                    <h3 class="mb-0">
                        @if (Model.IsPasswordExpired)
                        {
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        }
                        @ViewData["Title"]
                    </h3>
                </div>
                
                <div class="card-body p-4">
                    @if (Model.IsPasswordExpired)
                    {
                        <div class="alert alert-danger">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="alert-heading">Password Expired!</h5>
                                    <p class="mb-0">@Model.ExpiryMessage</p>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- MINIMUM PASSWORD AGE WARNING - ONLY ONE MESSAGE -->
                    @if (!Model.IsPasswordExpired && Model.LastPasswordChange.HasValue && !Model.CanChangePassword)
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-clock-history fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading">Minimum Password Age Policy</h6>
                                    <p class="mb-0">
                                        Last changed: <strong>@Model.LastPasswordChange.Value.ToString("HH:mm:ss") UTC</strong><br/>
                                        @ViewData["MinAgeWarning"]
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- SUCCESS MESSAGE -->
                    @if (!string.IsNullOrEmpty(Model.StatusMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill"></i> @Model.StatusMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- TEMP DATA SUCCESS MESSAGE (for expired password redirect) -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form method="post">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="All" class="text-danger mb-3"></div>

                        <div class="mb-3">
                            <label asp-for="Input.CurrentPassword" class="form-label fw-bold">Current Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                <input asp-for="Input.CurrentPassword" type="password" class="form-control" 
                                       placeholder="Enter your current password" autocomplete="off" />
                            </div>
                            <span asp-validation-for="Input.CurrentPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.NewPassword" class="form-label fw-bold">New Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key"></i></span>
                                <input asp-for="Input.NewPassword" type="password" class="form-control" 
                                       id="newPassword" placeholder="Enter new password" autocomplete="off" />
                            </div>
                            <span asp-validation-for="Input.NewPassword" class="text-danger"></span>
                            <div id="passwordStrength" class="mt-2"></div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Input.ConfirmPassword" class="form-label fw-bold">Confirm New Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input asp-for="Input.ConfirmPassword" type="password" class="form-control" 
                                       placeholder="Confirm your new password" autocomplete="off" />
                            </div>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                        </div>

                        @if (Model.CanChangePassword || Model.IsPasswordExpired)
                        {
                            <button type="submit" class="btn @(Model.IsPasswordExpired ? "btn-danger" : "btn-primary") w-100 py-2 fw-bold mb-3">
                                @if (Model.IsPasswordExpired)
                                {
                                    <i class="bi bi-shield-lock"></i> <span>Change Expired Password Now</span>
                                }
                                else
                                {
                                    <i class="bi bi-key"></i> <span>Change Password</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-secondary w-100 py-2 fw-bold mb-3" disabled>
                                <i class="bi bi-clock"></i> @ViewData["MinAgeWarning"]
                            </button>
                        }

                        @if (!Model.IsPasswordExpired)
                        {
                            <div class="text-center">
                                <a asp-page="/Index" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Back to Home
                                </a>
                            </div>
                        }
                    </form>
                </div>
            </div>

            <!-- Password Requirements Card -->
            <div class="card mt-4 border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Password Requirements</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li>Minimum 12 characters long</li>
                        <li>At least 1 uppercase letter (A-Z)</li>
                        <li>At least 1 lowercase letter (a-z)</li>
                        <li>At least 1 number (0-9)</li>
                        <li>At least 1 special character (!&#64;#$%^&* etc.)</li>
                        <li>Cannot reuse last 2 passwords</li>
                        <li><strong>Minimum password age: @Model.MinAgeMinutes minute(s)</strong> - cannot change password too frequently</li>
                        <li>Password expires every 2 minutes (for demo purposes)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- Password Strength Meter -->
    <script>
        (function() {
            const passwordInput = document.getElementById('newPassword');
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (passwordInput && strengthDiv) {
                function checkPasswordStrength(password) {
                    let score = 0;
                    if (!password) return 0;
                    if (password.length >= 12) score += 2;
                    else if (password.length >= 8) score += 1;
                    if (/[a-z]/.test(password)) score += 1;
                    if (/[A-Z]/.test(password)) score += 1;
                    if (/\d/.test(password)) score += 1;
                    if (/[^A-Za-z0-9]/.test(password)) score += 1;
                    return score;
                }
                
                function getStrengthLabel(score) {
                    if (score >= 6) return { text: 'Very Strong', class: 'bg-success', icon: 'bi-shield-check' };
                    if (score >= 5) return { text: 'Strong', class: 'bg-success', icon: 'bi-shield' };
                    if (score >= 4) return { text: 'Good', class: 'bg-info', icon: 'bi-shield' };
                    if (score >= 3) return { text: 'Fair', class: 'bg-warning', icon: 'bi-exclamation-triangle' };
                    if (score >= 2) return { text: 'Weak', class: 'bg-danger', icon: 'bi-exclamation-triangle' };
                    return { text: 'Very Weak', class: 'bg-danger', icon: 'bi-exclamation-triangle-fill' };
                }
                
                function updateStrengthIndicator() {
                    const password = passwordInput.value;
                    const score = checkPasswordStrength(password);
                    const strength = getStrengthLabel(score);
                    
                    strengthDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-2">
                                <i class="bi ${strength.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar ${strength.class}" 
                                         role="progressbar" 
                                         style="width: ${(score / 6) * 100}%"
                                         aria-valuenow="${score}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="6">
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0 ms-2">
                                <small class="fw-bold ${strength.class.replace('bg-', 'text-')}">
                                    ${strength.text}
                                </small>
                            </div>
                        </div>
                    `;
                }
                
                passwordInput.addEventListener('input', updateStrengthIndicator);
                updateStrengthIndicator();
            }
        })();
    </script>
}